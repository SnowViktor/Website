---
import CollectionLayout from "@layouts/CollectionLayout.astro";
import { getCollection } from "astro:content";
import path from "node:path";

export async function getStaticPaths() {
  const articles = await getCollection("articles");
  const paths = new Set();

  // Collect all folder paths
  articles.forEach((article) => {
    const dir = article.id.split("/").slice(0, -1).join("/");
    if (dir) {
      // Add "2024/02"
      paths.add(dir);
      // Also add parent "2024" if simpler logic needed, but let's assume direct parent for now or all parts?
      // If we want clickable breadcrumbs, we need pages for "2024" AND "2024/02".
      // Let's generate all intermediate paths.
      const parts = dir.split("/");
      let accum = "";
      parts.forEach((part) => {
        accum = accum ? `${accum}/${part}` : part;
        paths.add(accum);
      });
    }
  });

  return Array.from(paths).map((folderPath) => {
    // Filter articles starting with this path
    const filteredArticles = articles
      .filter((a) => a.id.startsWith(folderPath + "/"))
      .sort((a, b) => b.data.pub_date.valueOf() - a.data.pub_date.valueOf());

    return {
      params: { path: folderPath },
      props: { articles: filteredArticles, folderName: folderPath },
    };
  });
}

const { folderName, articles } = Astro.props;
---

<CollectionLayout
  title={`Folder: ${folderName}`}
  description={`Browse notes in ${folderName}`}
  articles={articles}
/>
